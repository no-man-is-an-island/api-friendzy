<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>API Friendzy</title>

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://fb.me/react-0.14.6.js"></script>
    <script src="https://fb.me/react-dom-0.14.6.js"></script>

    <!--TODO: remove JSX in browser transformer before this goes to prod.-->
    <script src="http://fb.me/JSXTransformer-0.12.1.js"></script>
    <style>
        body {
            padding-top: 50px;
        }

        li.friend {
            list-style: none;
            padding: 5px;
            margin-bottom: 5px;
            width: fit-content;
        }

        ul.friendsList {
            padding-top: 10px;
            padding-left: 0px;
        }

        .extendedFriend {
            padding-top: 10px;
            padding-left: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <div id="mainContent"></div>
</div>

<script type="text/jsx">
  var MainApp = React.createClass({
    getInitialState: function () {
      return {
        friends: []
      }
    },

    getFriends: function (filter) {
      $.getJSON("/api/friends",
        (filter === "") ? {} : {filter: filter},
        function (response) {
          this.setState({friends: response})
        }.bind(this));
    },

    componentDidMount() {
      this.getFriends()
    },

    render: function () {
      return (
        <div>
          <Search searchFn={this.getFriends}/>
          <FriendsList friends={this.state.friends}/>
        </div>
      );
    }
  });

  var Search = React.createClass({
    getInitialState: function () {
      return {
        filter: ""
      }
    },

    changeFilter: function (event) {
      this.setState({filter: event.target.value});
    },

    searchFriends: function (event) {
      event.preventDefault();
      this.props.searchFn(this.state.filter);
      return false
    },

    render: function () {
      return (
        <form onSubmit={this.searchFriends}>
          <input type="text" value={this.props.filter} onChange={this.changeFilter}/>
          <input type="submit" value={"Search friends.."}/>
        </form>
      );
    }
  });

  var FriendsList = React.createClass({
    render: function () {
      var friends = this.props.friends.map(function (friend) {
        return <Friend friend={friend} key={friend.id}/>
      });
      return (
        <ul className={"friendsList"}>
          {friends}
        </ul>
      );
    }
  });

  var Friend = React.createClass({
     render: function () {
        return <li className="friend">
          {this.props.friend.firstName} {this.props.friend.lastName} <ExtendedFriendInformation friendId={this.props.friend.id}/>
        </li>;
      }
    });

  var ExtendedFriendInformation = React.createClass({
    getInitialState: function () {
      return {}
    },

    loadExtendedInformation: function (event) {
      event.preventDefault();
      $.getJSON(`/api/friends/${this.props.friendId}`,
        function (response) {
          this.setState({friend: response})
        }.bind(this));
    },

    render: function () {
      if (this.state.friend === undefined){
        return <a href="#" onClick={this.loadExtendedInformation}> (More..)</a>;
      } else {
        return <div className={"extendedFriend"}>
          First Name: {this.state.friend.firstName} <br/>
          Last Name: {this.state.friend.lastName} <br/>
          Email: {this.state.friend.emailAddress} <br/>
          Created: {this.state.friend.createdAt} <br/>
          </div>
      }
    }
  });

  ReactDOM.render(<MainApp/>, document.getElementById("mainContent"));

</script>

</body>
</html>
